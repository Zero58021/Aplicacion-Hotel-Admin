<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-title>{{ initial?.numero ? 'Asignar / Editar Reserva' : 'Nueva Reserva' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cancel()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-light ion-padding">
  <div class="form-container fade-in">
    
    <div class="form-card">
      <div class="card-header">
        <ion-icon name="person-outline"></ion-icon>
        <span>Datos del Cliente</span>
      </div>

      <div class="input-group">
        <label>Titular de la reserva</label>
        <div class="custom-input" [class.disabled]="isRecepcion && !!initial?.numero">
          <ion-icon name="id-card-outline"></ion-icon>
          <input type="text" placeholder="Nombre completo" [(ngModel)]="reserva.titular" (input)="updateTitularFromInput($event)" [disabled]="isRecepcion && (!!initial?.numero)">
        </div>
      </div>
    </div>

    <div class="form-card" *ngIf="reserva.selectedCategories && reserva.selectedCategories.length > 0">
      <div class="card-header">
        <ion-icon name="bed-outline"></ion-icon>
        <span>Habitaciones Web</span>
      </div>

      <div *ngFor="let cat of reserva.selectedCategories; let i = index; trackBy: trackByIndex" style="margin-bottom: 16px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; background: #fafafa;">
        <strong style="color: #2c3e50; font-size: 0.95rem; display: block; margin-bottom: 8px;">
          {{ cat.qty }}x {{ cat.name }} ({{ cat.type }})
        </strong>
        
        <div *ngFor="let dummy of getArray(cat.qty); let j = index; trackBy: trackByIndex" class="input-group" style="margin-bottom: 8px;">
          <div class="custom-input">
            <ion-icon name="key-outline"></ion-icon>
            <select class="native-select" [(ngModel)]="asignaciones[cat.type + '_' + j]" (ngModelChange)="updateRooms()" style="width: 100%; border: none; background: transparent; outline: none; font-size: 0.95rem; font-weight: 600;">
              <option value="" disabled selected>Elige habitación libre...</option>
              <option *ngFor="let room of getAvailableRooms(cat.type, cat.type + '_' + j); trackBy: trackByRoom" [value]="room.numero">
                Nº {{ room.numero }} - Planta {{ room.planta || 'N/A' }}
              </option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="form-card" *ngIf="asignacionesManuales.length > 0">
      <div class="card-header">
        <ion-icon name="bed-outline"></ion-icon>
        <span>{{ reserva.selectedCategories?.length ? 'Habitaciones Extra (Añadidas)' : 'Habitaciones Asignadas' }}</span>
      </div>

      <div *ngFor="let dummy of getArray(asignacionesManuales.length); let i = index; trackBy: trackByIndex" class="input-group" style="margin-bottom: 12px;">
        <label>Habitación {{ reserva.selectedCategories?.length ? 'Extra ' : '' }}{{ i + 1 }}</label>
        <div class="custom-input">
          <ion-icon name="key-outline"></ion-icon>
          <select class="native-select" [(ngModel)]="asignacionesManuales[i]" (ngModelChange)="updateRooms()" style="width: 100%; border: none; background: transparent; outline: none; font-size: 0.95rem; font-weight: 600;">
            <option value="" disabled selected>Elige tipo y nº habitación...</option>
            <optgroup *ngFor="let group of groupedAvailableRoomsManual(i); trackBy: trackByGroup" [label]="group.tipo + ' (' + group.precio + '€/n)'">
              <option *ngFor="let room of group.rooms; trackBy: trackByRoom" [value]="room.numero">
                Nº {{ room.numero }}
              </option>
            </optgroup>
          </select>
        </div>
      </div>
    </div>

    <div class="form-card">
      <div class="card-header">
        <ion-icon name="calendar-outline"></ion-icon>
        <span>Estancia y Cantidades</span>
      </div>

      <div class="form-row">
        <div class="input-group half">
          <label>Entrada</label>
          <div class="custom-input date-input-wrapper">
            <ion-datetime-button datetime="entrada"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template><ion-datetime id="entrada" presentation="date" [(ngModel)]="reserva.fechaEntrada" (ionChange)="recalculatePrice()"></ion-datetime></ng-template>
            </ion-modal>
          </div>
        </div>

        <div class="input-group half">
          <label>Salida</label>
          <div class="custom-input date-input-wrapper">
            <ion-datetime-button datetime="salida"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template><ion-datetime id="salida" presentation="date" [(ngModel)]="reserva.fechaSalida" (ionChange)="recalculatePrice()"></ion-datetime></ng-template>
            </ion-modal>
          </div>
        </div>
      </div>

      <div class="form-row mt-2">
        <div class="input-group third">
          <label>Habitaciones</label>
          <div class="stepper-input">
            <ion-button fill="clear" (click)="changeRooms(-1)" [disabled]="reserva.numeroHabitaciones <= 1"><ion-icon name="remove"></ion-icon></ion-button>
            <span>{{ reserva.numeroHabitaciones }}</span>
            <ion-button fill="clear" (click)="changeRooms(1)"><ion-icon name="add"></ion-icon></ion-button>
          </div>
        </div>
        <div class="input-group third">
          <label>Adultos</label>
          <div class="stepper-input">
            <ion-button fill="clear" (click)="changeGuests('adultos', -1)" [disabled]="reserva.adultos <= 1"><ion-icon name="remove"></ion-icon></ion-button>
            <span>{{ reserva.adultos }}</span>
            <ion-button fill="clear" (click)="changeGuests('adultos', 1)"><ion-icon name="add"></ion-icon></ion-button>
          </div>
        </div>
        <div class="input-group third">
          <label>Niños</label>
          <div class="stepper-input">
            <ion-button fill="clear" (click)="changeGuests('ninos', -1)" [disabled]="reserva.ninos <= 0"><ion-icon name="remove"></ion-icon></ion-button>
            <span>{{ reserva.ninos }}</span>
            <ion-button fill="clear" (click)="changeGuests('ninos', 1)"><ion-icon name="add"></ion-icon></ion-button>
          </div>
        </div>
      </div>
    </div>

    <div class="form-card passengers-card shadow-card">
      <div class="card-header">
        <ion-icon name="people-outline"></ion-icon>
        <span>Datos de los Ocupantes (Check-in)</span>
      </div>

      <div class="people-actions" *ngIf="!formVisible && canAddPassenger()">
        <ion-button color="primary" expand="block" shape="round" fill="outline" (click)="togglePassengers()">
          <ion-icon name="person-add-outline" slot="start"></ion-icon>
          Añadir Información
        </ion-button>
      </div>

      <div *ngIf="formVisible" class="passengers-form-container mt-3">
        
        <div *ngFor="let p of reserva.passengers; let i = index" class="passenger-form-wrapper" id="passenger-{{i}}">
          <ng-container *ngIf="editingIndex === i">
            <div class="form-box" [class.primary-box]="p.isPrimary" style="border: 2px solid var(--ion-color-primary); padding: 15px; border-radius: 12px; margin-bottom: 15px; background: white;">
              
              <div class="form-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div class="header-titles">
                  <h3 style="margin: 0; font-size: 1.1rem; color: var(--ion-color-primary);">{{ p.isPrimary ? 'Titular' : ('Acompañante ' + i) }}</h3>
                  <ion-badge [color]="p.isPrimary ? 'primary' : 'medium'">{{ p.type === 'adult' ? 'Adulto' : 'Niño' }}</ion-badge>
                </div>
              </div>

              <div class="form-grid">
                <div class="input-group">
                  <label>Nombre</label>
                  <div class="custom-input" [class.border-danger]="passengersErrors[i]?.name"><input [(ngModel)]="p.name" placeholder="Ej. Juan"></div>
                  <span style="color: red; font-size: 0.75rem;" *ngIf="passengersErrors[i]?.name">Requerido</span>
                </div>
                
                <div class="input-group">
                  <label>Apellidos</label>
                  <div class="custom-input" [class.border-danger]="passengersErrors[i]?.lastName"><input [(ngModel)]="p.lastName" placeholder="Ej. Pérez"></div>
                  <span style="color: red; font-size: 0.75rem;" *ngIf="passengersErrors[i]?.lastName">Requerido</span>
                </div>

                <div class="input-group full-width">
                  <label>Documento (DNI/NIE)</label>
                  <div class="custom-input" [class.border-danger]="passengersErrors[i]?.dni"><input [(ngModel)]="p.dni" placeholder="Ej. 12345678A"></div>
                  <span style="color: red; font-size: 0.75rem;" *ngIf="passengersErrors[i]?.dni">Formato Inválido</span>
                </div>

                <ng-container *ngIf="p.isPrimary">
                  <div class="input-group half" style="display: inline-block; width: 48%; margin-right: 2%;">
                    <label>Teléfono</label>
                    <div class="custom-input" [class.border-danger]="passengersErrors[i]?.phone"><input type="tel" [(ngModel)]="p.phone" placeholder="Ej. 600123456"></div>
                    <span style="color: red; font-size: 0.75rem;" *ngIf="passengersErrors[i]?.phone">Inválido</span>
                  </div>

                  <div class="input-group half" style="display: inline-block; width: 48%;">
                    <label>Correo Electrónico</label>
                    <div class="custom-input" [class.border-danger]="passengersErrors[i]?.email"><input type="email" [(ngModel)]="p.email" placeholder="correo@mail.com"></div>
                    <span style="color: red; font-size: 0.75rem;" *ngIf="passengersErrors[i]?.email">Inválido</span>
                  </div>
                </ng-container>

                <div class="input-group full-width" *ngIf="!p.isPrimary">
                   <label>Tipo de pasajero</label>
                   <ion-segment [(ngModel)]="p.type" mode="ios">
                    <ion-segment-button value="adult">Adulto</ion-segment-button>
                    <ion-segment-button value="child">Niño</ion-segment-button>
                  </ion-segment>
                </div>
              </div>

              <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                <ion-button color="medium" fill="clear" size="small" (click)="closeEditing()">Cancelar</ion-button>
                <ion-button color="danger" fill="clear" size="small" *ngIf="!p.isPrimary" (click)="removePassenger(i)">Eliminar</ion-button>
                <ion-button color="success" size="small" (click)="savePassengers()">Guardar Pasajero</ion-button>
              </div>
            </div>
          </ng-container>
        </div>

        <div class="add-buttons" *ngIf="editingIndex === null" style="display: flex; gap: 10px; margin-top: 10px;">
          <ion-button color="primary" fill="outline" (click)="addPrimary()" *ngIf="!hasPrimary()"><ion-icon name="add" slot="start"></ion-icon> Titular</ion-button>
          <ion-button color="secondary" fill="outline" (click)="addPassenger()" *ngIf="hasPrimary() && canAddPassenger()"><ion-icon name="add" slot="start"></ion-icon> Acompañante</ion-button>
        </div>

      </div>

      <div *ngIf="reserva.passengers && reserva.passengers.length > 0 && editingIndex === null" class="passengers-summary mt-3">
        <div class="passenger-item" *ngFor="let p of reserva.passengers; let i = index" [class.is-primary]="p.isPrimary" style="display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 12px; padding: 10px 14px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <ion-icon [name]="p.isPrimary ? 'star' : 'person'" [color]="p.isPrimary ? 'primary' : 'medium'" style="font-size: 1.5rem;"></ion-icon>
            <div>
              <div style="font-weight: bold; color: #1e293b;">{{ p.name }} {{ p.lastName }}</div>
              <div style="font-size: 0.8rem; color: #64748b;">{{ p.type === 'adult' ? 'Adulto' : 'Niño' }} • DNI: {{ p.dni || 'No especificado' }}</div>
            </div>
          </div>
          <div>
            <ion-button fill="clear" size="small" (click)="editPassenger(i)"><ion-icon name="pencil" slot="icon-only"></ion-icon></ion-button>
            <ion-button *ngIf="!p.isPrimary" color="danger" fill="clear" size="small" (click)="removePassenger(i)"><ion-icon name="trash" slot="icon-only"></ion-icon></ion-button>
          </div>
        </div>
      </div>
    </div>

    <div class="form-card">
      <div class="card-header">
        <ion-icon name="restaurant-outline"></ion-icon>
        <span>Régimen y Precio</span>
      </div>

      <div class="input-group">
        <label>Tipo de Pensión</label>
        <div class="chip-grid">
          <div class="chip-item" *ngFor="let p of pensionOptions" [class.active]="reserva.pension === p" (click)="selectPension(p)">
            <span>{{ p }}</span>
          </div>
        </div>
      </div>

      <div class="input-group mt-2" *ngIf="auth.getRole() === 'jefe'">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <label>Precio Total</label>
          <span class="breakdown-toggle" (click)="showBreakdown = !showBreakdown">
            <ion-icon [name]="showBreakdown ? 'chevron-up-outline' : 'receipt-outline'"></ion-icon> 
            {{ showBreakdown ? 'Ocultar' : 'Ver desglose' }}
          </span>
        </div>
        <div class="custom-input price-input" [class.breakdown-open]="showBreakdown">
          <input type="number" placeholder="0.00" [(ngModel)]="reserva.precioTotal" (ngModelChange)="recalculatePrice(false)">
          <span class="unit" style="color:var(--ion-color-success)">€</span>
        </div>

        <div class="receipt-ticket slide-down" *ngIf="showBreakdown">
           <div class="receipt-header">
              <div class="receipt-row"><span><strong>Entrada:</strong> {{ reserva.fechaEntrada | date:'dd/MM/yyyy' }}</span><span><strong>Salida:</strong> {{ reserva.fechaSalida | date:'dd/MM/yyyy' }}</span></div>
              <div class="receipt-row"><span><strong>Huéspedes:</strong> {{ reserva.adultos }} Ad, {{ reserva.ninos }} Ni</span><span><strong>Noches:</strong> {{ breakdown.nights }}</span></div>
           </div>
           <div class="receipt-divider"></div>
           <div class="receipt-item" *ngFor="let r of breakdown.rooms">
              <div class="item-info"><span class="item-name">{{r.qty}}x {{ r.name }}</span><span class="item-sub">{{r.price}}€ / noche</span></div><span class="item-total">{{ r.total }}€</span>
           </div>
           <div class="receipt-item" *ngIf="breakdown.pensionTotal > 0">
              <div class="item-info"><span class="item-name">{{ reserva.pension }}</span><span class="item-sub">{{breakdown.pensionPxN}}€ / pax / noche</span></div><span class="item-total">{{ breakdown.pensionTotal }}€</span>
           </div>
           <div class="receipt-divider"></div>
           <div class="receipt-total"><span>TOTAL SISTEMA</span><span>{{ breakdown.mathTotal }}€</span></div>
           <div class="receipt-alert" *ngIf="breakdown.mathTotal !== reserva.precioTotal">
             <ion-icon name="warning"></ion-icon> El importe cobrado ({{reserva.precioTotal}}€) difiere del cálculo.
           </div>
        </div>
      </div>
    </div>

    <div class="form-card">
      <div class="card-header">
        <ion-icon name="information-circle-outline"></ion-icon>
        <span>Requisitos y Estado</span>
      </div>

      <div class="toggles-container">
        <ion-item lines="none" class="custom-toggle">
          <ion-icon name="paw-outline" slot="start"></ion-icon>
          <ion-label>Viaja con Mascota</ion-label>
          <ion-toggle slot="end" color="primary" [(ngModel)]="reserva.mascota"></ion-toggle>
        </ion-item>
        <ion-item lines="none" class="custom-toggle">
          <ion-icon name="medical-outline" slot="start"></ion-icon>
          <ion-label>Tiene Alergias</ion-label>
          <ion-toggle slot="end" color="danger" [(ngModel)]="reserva.hasAllergies"></ion-toggle>
        </ion-item>
      </div>

      <div class="input-group mt-2 slide-down" *ngIf="reserva.hasAllergies">
        <label style="color: var(--ion-color-danger)">Alergias / Intolerancias (Describir)</label>
        <div class="custom-input textarea-input" style="border-color: rgba(var(--ion-color-danger-rgb), 0.3)">
          <textarea rows="2" placeholder="Ej: Mariscos, celiaquía, frutos secos..." [(ngModel)]="reserva.alergias"></textarea>
        </div>
      </div>

      <div class="input-group mt-3" *ngIf="!isRecepcion">
        <label>Estado de la Reserva</label>
        <div class="chip-grid">
          <div class="chip-item pendiente" [class.active]="reserva.status === 'Pendiente'" (click)="setEstado('Pendiente')">
            <ion-icon name="time-outline"></ion-icon> <span>Pendiente</span>
          </div>
          <div class="chip-item confirmada" [class.active]="reserva.status === 'Confirmada'" (click)="setEstado('Confirmada')">
            <ion-icon name="checkmark-circle-outline"></ion-icon> <span>Confirmada</span>
          </div>
          <div class="chip-item denegada" [class.active]="reserva.status === 'Denegada'" (click)="setEstado('Denegada')">
            <ion-icon name="close-circle-outline"></ion-icon> <span>Denegada</span>
          </div>
          <div class="chip-item cancelada" [class.active]="reserva.status === 'Cancelada' || reserva.status === 'Cancelada por cliente'" (click)="setEstado('Cancelada')">
            <ion-icon name="ban-outline"></ion-icon> <span>Cancelada</span>
          </div>
        </div>
      </div>
    </div>

    <div class="action-buttons-bottom">
      <ion-button expand="block" fill="clear" color="medium" class="cancel-btn" (click)="cancel()">CERRAR</ion-button>
      <ion-button *ngIf="isRecepcion && !!initial?.numero" expand="block" color="danger" fill="outline" class="client-cancel-btn" (click)="cancelAsClient()">CANCELAR</ion-button>
      <ion-button expand="block" color="primary" class="main-btn" (click)="save()">{{ (reserva.status === 'Pendiente') ? 'ASIGNAR Y CONFIRMAR' : 'GUARDAR' }}</ion-button>
    </div>

  </div>
  <div class="modal-end-space" aria-hidden="true"></div>
</ion-content>