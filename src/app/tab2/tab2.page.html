<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Reservas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" (ionScroll)="onContentScroll($event)" scrollEvents="true" class="bg-light">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Reservas</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="filters">
    <div class="search-wrapper">
      <ion-icon name="search-outline"></ion-icon>
      <input type="text" placeholder="Buscar por titular o ID..." (input)="onSearch($event)">
    </div>

    <div class="chip-carousel" *ngIf="auth.getRole() !== 'recepcion' && auth.getRole() !== 'restaurante'">
      <ion-chip [class.active]="statusFilter === 'Todos'" (click)="setFilter('Todos')">
        <ion-label>Todos</ion-label>
      </ion-chip>
      <ion-chip [class.active]="statusFilter === 'Pendiente'" (click)="setFilter('Pendiente')" class="chip-pendiente">
        <ion-label>Pendientes</ion-label>
      </ion-chip>
      <ion-chip [class.active]="statusFilter === 'Confirmada'" (click)="setFilter('Confirmada')" class="chip-confirmada">
        <ion-label>Confirmadas</ion-label>
      </ion-chip>
      <ion-chip [class.active]="statusFilter === 'Cancelada'" (click)="setFilter('Cancelada')" class="chip-cancelada">
        <ion-label>Canceladas</ion-label>
      </ion-chip>
      <ion-chip [class.active]="statusFilter === 'Denegada'" (click)="setFilter('Denegada')" class="chip-denegada">
        <ion-label>Denegadas</ion-label>
      </ion-chip>
      <ion-chip [class.active]="statusFilter === 'Completada'" (click)="setFilter('Completada')" class="chip-completada">
        <ion-label>Completadas</ion-label>
      </ion-chip>
    </div>
  </div>
  
  <div class="content-wrapper">
    <div class="res-list" *ngIf="filteredReservas?.length; else empty">
      
      <div *ngFor="let r of filteredReservas" class="res-card" [ngClass]="r.status?.toLowerCase()" [class.expanded]="r.expanded">
        
        <div class="res-header" (click)="toggleExpand(r)">
          <div class="res-status-bar"></div>
          
          <div class="res-main-info">
            <div class="res-title-row">
              <span class="res-id">{{ r.numero }}</span>
              <ion-badge class="status-badge">{{ r.status || 'Pendiente' }}</ion-badge>
            </div>
            <h2 class="res-titular">{{ r.titular }}</h2>
            <div class="res-room">
              <ion-icon name="bed-outline"></ion-icon> 
              {{ r.numeroHabitaciones }} habs. ({{ r.habitacion && r.habitacion !== 'Sin asignar' ? formatHabitacionesInfo(r.habitacion) : 'Sin asignar' }})
            </div>
          </div>

          <div class="res-dates-vertical">
            <div class="date-line">
              <span class="d-label">F. Entrada</span>
              <span class="d-val">{{ formatDate(r.fechaEntrada) }}</span>
            </div>
            <div class="date-line">
              <span class="d-label">F. Salida</span>
              <span class="d-val">{{ formatDate(r.fechaSalida) }}</span>
            </div>
          </div>
          
          <div class="expand-btn">
            <ion-icon [name]="r.expanded ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
          </div>
        </div>

        <div class="res-details" *ngIf="r.expanded">
          <div class="detail-grid">
            
            <div class="d-item" *ngIf="auth.getRole() !== 'restaurante'">
              <ion-icon name="people-outline"></ion-icon>
              <div>
                <span class="d-item-title">Huéspedes</span>
                <span class="d-item-val">{{ r.adultos }} Ad, {{ r.ninos }} Ni</span>
              </div>
            </div>

            <div class="d-item">
              <ion-icon name="restaurant-outline"></ion-icon>
              <div>
                <span class="d-item-title">Pensión</span>
                <span class="d-item-val">{{ r.pension || '-' }}</span>
              </div>
            </div>

            <div class="d-item" *ngIf="auth.getRole() !== 'restaurante'">
              <ion-icon name="paw-outline"></ion-icon>
              <div>
                <span class="d-item-title">Mascota</span>
                <span class="d-item-val">{{ r.mascota ? 'Sí' : 'No' }}</span>
              </div>
            </div>

            <div class="d-item">
              <ion-icon name="medical-outline" [color]="r.hasAllergies ? 'danger' : 'success'"></ion-icon>
              <div>
                <span class="d-item-title" [class.text-danger]="r.hasAllergies">Alergias / Notas</span>
                <span class="d-item-val" [class.text-danger]="r.hasAllergies">{{ r.hasAllergies ? (r.alergias || 'Sí') : 'Ninguna' }}</span>
              </div>
            </div>

          </div>

          <div class="cart-details" *ngIf="r.selectedCategories?.length || r.habitacion">
            <strong>Habitaciones ({{ r.numeroHabitaciones }}):</strong>
            <ul>
              <li *ngFor="let cat of r.selectedCategories">
                {{ cat.qty }}x {{ cat.name }} 
                <span class="cart-price" *ngIf="auth.getRole() === 'jefe'">({{ cat.price }}€/n)</span>
              </li>
              <li *ngIf="r.habitacion" style="margin-top: 6px; padding: 6px; background: #e0f2fe; color: #0284c7; border-radius: 6px; font-weight: 600;">
                <ion-icon name="key-outline" style="margin-right: 4px; vertical-align: bottom;"></ion-icon>
                Asignadas: {{ formatHabitacionesInfo(r.habitacion) }}
              </li>
            </ul>
          </div>

          <div class="res-total-container" *ngIf="auth.getRole() === 'jefe'">
            
            <div class="res-total">
              <div style="display: flex; flex-direction: column;">
                <span>Importe Total:</span>
                <span class="breakdown-toggle" (click)="toggleBreakdown(r, $event)">
                  <ion-icon [name]="r.showBreakdown ? 'chevron-up-outline' : 'receipt-outline'"></ion-icon> 
                  {{ r.showBreakdown ? 'Ocultar desglose' : 'Ver desglose' }}
                </span>
              </div>
              <strong [class.has-alert]="r.breakdownData && (r.breakdownData.mathTotal !== r.precioTotal)">
                {{ formatCurrency(r.precioTotal) }}
              </strong>
            </div>

            <div class="receipt-ticket slide-down" *ngIf="r.showBreakdown && r.breakdownData">
               
               <div class="receipt-header">
                  <div class="receipt-row">
                    <span><strong>Entrada:</strong> {{ formatDate(r.fechaEntrada) }}</span>
                    <span><strong>Salida:</strong> {{ formatDate(r.fechaSalida) }}</span>
                  </div>
                  <div class="receipt-row">
                    <span><strong>Huéspedes:</strong> {{ r.adultos }} Ad, {{ r.ninos }} Ni</span>
                    <span><strong>Noches:</strong> {{ r.breakdownData.nights }}</span>
                  </div>
               </div>
               
               <div class="receipt-divider"></div>
               
               <div class="receipt-item" *ngFor="let rm of r.breakdownData.roomsInfo">
                  <div class="item-info">
                     <span class="item-name">{{rm.qty}}x {{ rm.name }}</span>
                     <span class="item-sub">{{ formatCurrency(rm.price) }} / noche</span>
                  </div>
                  <span class="item-total">{{ formatCurrency(rm.total) }}</span>
               </div>
               
               <div class="receipt-item" *ngIf="r.breakdownData.pensionTotal > 0">
                  <div class="item-info">
                     <span class="item-name">{{ r.breakdownData.pensionName }}</span>
                     <span class="item-sub">{{r.breakdownData.pensionPxN}}€ / pax / noche</span>
                  </div>
                  <span class="item-total">{{ formatCurrency(r.breakdownData.pensionTotal) }}</span>
               </div>
               
               <div class="receipt-divider"></div>
               
               <div class="receipt-total">
                  <span>TOTAL SISTEMA</span>
                  <span>{{ formatCurrency(r.breakdownData.mathTotal) }}</span>
               </div>

               <div class="receipt-alert" *ngIf="r.breakdownData.mathTotal !== r.precioTotal">
                 <ion-icon name="warning"></ion-icon>
                 El importe cobrado ({{formatCurrency(r.precioTotal)}}) difiere del sistema.
               </div>
            </div>
          </div>

          <div class="res-actions">
            
            <ion-button fill="outline" color="dark" size="small" (click)="generarTicketPDF(r, $event)">
              <ion-icon name="print-outline" slot="start"></ion-icon> Imprimir Ticket
            </ion-button>
            
            <ion-button *ngIf="auth.hasPermission('reservas.confirm') && r.status === 'Pendiente'" size="small" color="success" (click)="confirmReservation(r); $event.stopPropagation()">
              <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon> Asignar
            </ion-button>

            <ion-button *ngIf="auth.hasPermission('reservas.edit')" size="small" color="primary" (click)="openEditReservation(r); $event.stopPropagation()">
              <ion-icon name="pencil-outline" slot="start"></ion-icon> Editar
            </ion-button>

            <ion-button *ngIf="(auth.getRole() === 'recepcion' || auth.getRole() === 'jefe') && r.status === 'Cancelada'" size="small" color="success" (click)="reactivateReservation(r); $event.stopPropagation()">
              <ion-icon name="refresh-outline" slot="start"></ion-icon> Reactivar
            </ion-button>

            <ion-button *ngIf="auth.hasPermission('reservas.confirm') && r.status === 'Pendiente'" size="small" color="danger" fill="outline" (click)="denyReservation(r); $event.stopPropagation()">
              Denegar
            </ion-button>

            <ion-button *ngIf="(auth.getRole() === 'recepcion' || auth.getRole() === 'jefe') && (r.status === 'Confirmada' || r.status === 'Pendiente')" size="small" color="warning" (click)="cancelByClient(r); $event.stopPropagation()">
              Cancelar
            </ion-button>

            <ion-button size="small" color="danger" fill="clear" *ngIf="r.status === 'Denegada' || r.status === 'Completada' || r.status === 'Cancelada'" (click)="confirmDeleteReservation(r); $event.stopPropagation()">
              <ion-icon name="trash-outline" slot="start"></ion-icon> Borrar
            </ion-button>

          </div>

        </div>
      </div>

    </div>
  </div>

  <ng-template #empty>
    <div class="empty-state">
      <ion-icon name="document-text-outline"></ion-icon>
      <h3>Sin resultados</h3>
      <p>No hay reservas en la categoría "{{ statusFilter }}".</p>
    </div>
  </ng-template>

</ion-content>

<button class="scroll-top" [class.visible]="showScrollTop" (click)="scrollToTop()" aria-label="Ir arriba">
  <ion-icon name="chevron-up-outline"></ion-icon>
</button>

<ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="auth.getRole() !== 'restaurante'">
  <ion-fab-button class="add-reserva-fab" color="primary" (click)="openNewReservation()" aria-label="Nueva reserva">
    <ion-icon name="add-outline"></ion-icon>
  </ion-fab-button>
</ion-fab>