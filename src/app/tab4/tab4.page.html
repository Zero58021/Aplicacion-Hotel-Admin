<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Habitaciones</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="no-global-white" [fullscreen]="true" (ionScroll)="onContentScroll($event)" [scrollEvents]="true">
  <div class="search-wrap" style="padding: 8px 12px 0 12px;">
    <ion-searchbar placeholder="Buscar por nombre o número" [(ngModel)]="searchTerm" debounce="250"></ion-searchbar>
  </div>
  <div class="filters-row" style="padding: 6px 12px;">
    <ion-grid>
      <ion-row>
        <ion-col size="4">
          <ion-item>
            <ion-label>Tipo</ion-label>
            <ion-select multiple [(ngModel)]="selectedTypes" interface="popover" okText="OK" cancelText="CANCEL">
              <ion-select-option *ngFor="let t of roomTypes" [value]="t">{{ t }}</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>
        <ion-col size="4">
          <ion-item>
            <ion-label>Planta</ion-label>
            <ion-select multiple [(ngModel)]="selectedFloors" interface="popover" okText="OK" cancelText="CANCEL">
              <ion-select-option *ngFor="let f of floors" [value]="f">{{ f }}</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>
        <ion-col size="4">
          <ion-item>
            <ion-label>Estado</ion-label>
                <ion-select [(ngModel)]="selectedStatus" interface="popover" okText="OK" cancelText="CANCEL">
              <ion-select-option value="Todas">Todas</ion-select-option>
              <ion-select-option value="Limpieza">Limpieza</ion-select-option>
              <ion-select-option value="Mantenimiento">Mantenimiento</ion-select-option>
              <ion-select-option value="Reservada">Reservada</ion-select-option>
              <ion-select-option value="Ocupada">Ocupada</ion-select-option>
              <ion-select-option value="Libre">Libre</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Habitaciones</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="rooms-grid">
    <ion-card *ngFor="let room of filteredRooms; let i = index" class="room-card" [class.editing]="editingIndex === originalIndex(room)">
      <div class="card-media">
        <img style="cursor: zoom-in" (click)="openImage(room, imageIndex[originalIndex(room)] !== undefined ? imageIndex[originalIndex(room)] : 0)" [src]="(room.images && room.images.length) ? room.images[ (imageIndex[originalIndex(room)] !== undefined ? imageIndex[originalIndex(room)] : 0) ] : ''" alt="{{room.title}}">
        <ion-button *ngIf="room.images && room.images.length > 1" fill="clear" class="nav-btn left" (click)="prevImage(originalIndex(room))" aria-label="Anterior">
          <ion-icon name="chevron-back-outline"></ion-icon>
        </ion-button>
        <ion-button *ngIf="room.images && room.images.length > 1" fill="clear" class="nav-btn right" (click)="nextImage(originalIndex(room))" aria-label="Siguiente">
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </ion-button>
        <div class="image-counter" *ngIf="room.images && room.images.length > 0">{{ (imageIndex[originalIndex(room)] !== undefined ? imageIndex[originalIndex(room)] + 1 : 1) }}/{{ room.images.length }}</div>
        <ion-button *ngIf="editingIndex !== originalIndex(room) && auth.hasPermission('habitaciones.edit')" fill="clear" class="edit-btn" (click)="startEdit(originalIndex(room))" aria-label="Editar">
          <ion-icon name="pencil-outline"></ion-icon>
        </ion-button>
        <ion-button *ngIf="editingIndex !== originalIndex(room) && auth.hasPermission('habitaciones.edit')" fill="clear" color="danger" class="delete-btn" (click)="confirmDelete(originalIndex(room))" aria-label="Borrar">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
      </div>
      <ion-card-content>
        <ng-container *ngIf="editingIndex !== originalIndex(room); else editForm">
          <div class="title-row">
            <div style="display:flex;flex-direction:column;gap:4px;flex:1;">
              <h3 class="room-title">{{ room.title }}</h3>
              <div class="room-number-and-status">
                <div class="room-number">Nº {{ room.roomNumber }}</div>
                <ion-badge class="status-badge" [ngClass]="getStatusClass(room.status)">{{ room.status }}</ion-badge>
                <ng-container *ngIf="auth.hasPermission('habitaciones.estado') && auth.getRole() === 'mantenimiento'">
                  <ion-button *ngIf="room.status === 'Mantenimiento'" fill="outline" size="small" color="primary" (click)="setRoomStatus(originalIndex(room), 'Libre')" style="margin-left:8px">Marcar libre</ion-button>
                  <ion-button *ngIf="room.status !== 'Mantenimiento'" fill="clear" size="small" (click)="setRoomStatus(originalIndex(room), 'Mantenimiento')">Marcar Mantenimiento</ion-button>
                </ng-container>
                <ng-container *ngIf="auth.hasPermission('habitaciones.estado') && auth.getRole() !== 'mantenimiento'">
                  <ion-button *ngIf="room.status === 'Limpieza'" fill="outline" size="small" color="primary" (click)="setRoomStatus(originalIndex(room), 'Libre')" style="margin-left:8px">Marcar libre</ion-button>
                  <ion-button *ngIf="room.status !== 'Limpieza' && auth.getRole() !== 'jefe'" fill="clear" size="small" (click)="setRoomStatus(originalIndex(room), 'Limpieza')">Marcar Limpieza</ion-button>
                </ng-container>
              </div>
              <div class="rating-row" *ngIf="auth.getRole() !== 'limpieza' && auth.getRole() !== 'mantenimiento'">
                  <div class="stars">
                    <ion-icon *ngFor="let filled of starState(avgRating(room))" [name]="filled ? 'star' : 'star-outline'"></ion-icon>
                  </div>
                  <div class="avg-text">{{ avgRating(room) | number:'1.1-1' }} · {{ (room.reviews?.length || 0) }} opiniones</div>
                </div>
            </div>
            <ion-button *ngIf="auth.getRole() !== 'limpieza' && auth.getRole() !== 'mantenimiento'" fill="clear" class="reviews-btn" (click)="showReviews(room)" aria-label="Opiniones">
              <ion-icon name="chatbubbles-outline"></ion-icon>
            </ion-button>
          </div>

            <div class="type-floor-row">
            <div class="type">{{ room.type }}</div>
            <div class="floor">Planta: {{ room.floor }}</div>
          </div>

          <div class="meta-row" *ngIf="auth.getRole() !== 'limpieza' && auth.getRole() !== 'mantenimiento'">
            <div class="extras">
              <ion-badge *ngFor="let ex of room.extras" color="medium" class="extra">{{ ex }}</ion-badge>
            </div>
          </div>

          <div class="price-row" *ngIf="auth.getRole() !== 'limpieza' && auth.getRole() !== 'mantenimiento'">
            <div class="old-price">{{ room.oldPrice }}</div>
            <div class="price">{{ room.displayPrice }}</div>
          </div>

          <div class="note" *ngIf="auth.getRole() !== 'limpieza' && auth.getRole() !== 'mantenimiento'">{{ room.note }}</div>
        </ng-container>

        <ng-template #editForm>
          <div class="edit-form fade-in">
            
            <div class="form-card compact">
              <div class="card-header">
                <ion-icon name="images-outline"></ion-icon>
                <span>Fotografías</span>
              </div>
              <div class="photo-gallery">
                <div class="photo-item" *ngFor="let p of editModel.images; let idx = index">
                  <img [src]="p" alt="foto {{idx + 1}}">
                  <div class="photo-delete" (click)="removePhoto(idx)">
                    <ion-icon name="trash"></ion-icon>
                  </div>
                  <label class="photo-replace-btn">
                    <ion-icon name="sync-outline"></ion-icon>
                    <input type="file" accept="image/*" (change)="replacePhotoFile(idx, $event)">
                  </label>
                </div>
                
                <label class="photo-add-btn">
                  <ion-icon name="add"></ion-icon>
                  <input type="file" accept="image/*" (change)="addPhotoFile($event)">
                </label>
              </div>
            </div>

            <div class="form-card compact">
              <div class="form-row">
                <div class="input-group half">
                  <label>Nº Hab.</label>
                  <div class="custom-input">
                    <ion-icon name="key-outline"></ion-icon>
                    <input type="text" [(ngModel)]="editModel.roomNumber" [attr.name]="'roomNumber' + originalIndex(room)">
                  </div>
                </div>
                <div class="input-group half">
                  <label>Nombre</label>
                  <div class="custom-input">
                    <input type="text" [(ngModel)]="editModel.title" [attr.name]="'title' + originalIndex(room)">
                  </div>
                </div>
              </div>

              <div class="input-group mt-2">
                <label>Tipo de Habitación</label>
                <div class="custom-input">
                  <ion-icon name="layers-outline"></ion-icon>
                  <select [(ngModel)]="editModel.type" class="native-select" [attr.name]="'type' + originalIndex(room)">
                    <option *ngFor="let t of roomTypes" [value]="t">{{ t }}</option>
                  </select>
                </div>
              </div>

              <div class="input-group mt-2">
                <label>Estado Actual</label>
                <div class="chip-grid">
                  <div class="chip-item" [class.active]="editModel.status === 'Libre'" (click)="editModel.status = 'Libre'">
                    <ion-icon name="checkmark-circle-outline"></ion-icon> <span>Libre</span>
                  </div>
                  <div class="chip-item" [class.active]="editModel.status === 'Ocupada'" (click)="editModel.status = 'Ocupada'">
                    <ion-icon name="person-outline"></ion-icon> <span>Ocupada</span>
                  </div>
                  <div class="chip-item" [class.active]="editModel.status === 'Reservada'" (click)="editModel.status = 'Reservada'">
                    <ion-icon name="calendar-outline"></ion-icon> <span>Reservada</span>
                  </div>
                  <div class="chip-item" [class.active]="editModel.status === 'Limpieza'" (click)="editModel.status = 'Limpieza'">
                    <ion-icon name="sparkles-outline"></ion-icon> <span>Limpieza</span>
                  </div>
                  <div class="chip-item" [class.active]="editModel.status === 'Mantenimiento'" (click)="editModel.status = 'Mantenimiento'">
                    <ion-icon name="hammer-outline"></ion-icon> <span>Mant.</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-card compact">
              <div class="input-group">
                <label>Planta</label>
                <div class="chip-grid">
                  <div class="chip-item" *ngFor="let f of floors" [class.active]="editModel.floor === f" (click)="editModel.floor = f">
                    <ion-icon name="business-outline"></ion-icon> <span>{{ f }}</span>
                  </div>
                </div>
              </div>

              <div class="form-row mt-2">
                <div class="input-group half">
                  <label>Precio Anterior</label>
                  <div class="custom-input price-input">
                    <input type="number" [(ngModel)]="editModel.oldPrice" [attr.name]="'old' + originalIndex(room)">
                    <span class="unit">€</span>
                  </div>
                </div>
                <div class="input-group half">
                  <label>Precio Actual</label>
                  <div class="custom-input price-input">
                    <input type="number" [(ngModel)]="editModel.price" [attr.name]="'price' + originalIndex(room)">
                    <span class="unit" style="color:var(--ion-color-success)">€</span>
                  </div>
                </div>
              </div>

              <div class="input-group mt-2">
                <label>Descripción / Notas</label>
                <div class="custom-input textarea-input">
                  <textarea rows="3" [(ngModel)]="editModel.note" [attr.name]="'note' + originalIndex(room)"></textarea>
                </div>
              </div>
            </div>

            <div class="form-card compact">
              <div class="card-header" style="margin-bottom: 8px;">
                <ion-icon name="sparkles-outline"></ion-icon>
                <span>Extras</span>
              </div>
              <div class="extras-grid">
                <div class="extra-chip" *ngFor="let ex of extrasOptions" 
                     [class.active]="hasExtraEdit(ex)" (click)="toggleExtraEdit(ex)">
                  <span>{{ ex }}</span>
                </div>
              </div>
            </div>

            <div class="edit-actions-premium">
              <ion-button color="medium" fill="clear" (click)="cancelEdit()">Cancelar</ion-button>
              <div style="flex:1"></div>
              <ion-button *ngIf="auth.hasPermission('habitaciones.edit')" color="danger" fill="outline" (click)="confirmDelete(originalIndex(room))">Borrar</ion-button>
              <ion-button *ngIf="auth.hasPermission('habitaciones.edit')" color="primary" class="main-save-btn" (click)="saveEdit()">GUARDAR</ion-button>
            </div>
          </div>
        </ng-template>
      </ion-card-content>
    </ion-card>
  </div>

</ion-content>

<ion-fab vertical="bottom" horizontal="end" slot="fixed">
  <ion-fab-button *ngIf="auth.hasPermission('habitaciones.edit')" class="small-fab" color="primary" (click)="addNewRoom()" aria-label="Añadir habitación">
    <ion-icon class="fab-add-icon" name="add-outline"></ion-icon>
  </ion-fab-button>
</ion-fab>

<button class="scroll-top" 
        [class.visible]="showScrollTop" 
        [class.shift-left]="isJefe" 
        (click)="scrollToTop()" aria-label="Ir arriba">
  <ion-icon name="chevron-up-outline"></ion-icon>
</button>